version: '3.7'

x-node:
  &node
  image: node:lts
  command: node ./bin/dagflow orchester
  volumes:
    - .:/code
  environment:
    - REDIS_URL=redis://redis:6379
    - REDIS_URL=mongodb://mongo:27017/test
  working_dir: /code
  depends_on:
    - redis
    - mongo

services:
  mongo:
    image: mongo
    volumes:
      - ./compose/mongo:/data/db
  redis:
    image: "redis:alpine"
    volumes:
      - ./compose/redis/:/compose/redis
    healthcheck:
      test: ["CMD", "/compose/redis/docker-healthcheck"]

  orchester:
    <<: *node
    command: node ./bin/dagflow orchester
    ports:
      - "8001:8000"

  webserver:
    <<: *node
    command: node ./bin/dagflow webserver

    ports:
      - "8002:8000"

  worker:
    <<: *node
    command: node ./bin/dagflow worker
    ports:
      - "8003:8000"

  kue:
    <<: *node
    command: node ./bin/dagflow kue
    ports:
      - "8004:8000"

  mongo-express:
    image: mongo-express:latest
    restart: always
    ports:
      - "8005:8081"